<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dar Hassna - Gestion des Commandes et Menu</title>
  <style>
    :root {
      --color-primary: #d35400;
      --color-secondary: #5d4037;
      --color-pending: #856404;
      --color-preparing: #004085;
      --color-ready: #155724;
      --color-delivered: #383d41;
      --color-danger: #dc3545;
      --color-light: #f8f1e9;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-light);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    
    /* Styles pour les commandes */
    #ordersSection {
      display: block;
    }
    
    #menuSection {
      display: none;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background-color: #eee;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .tab-btn.active {
      background-color: var(--color-primary);
      color: white;
    }
    
    /* Styles communs pour les commandes et le menu */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background-color: #fff;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-item {
      text-align: center;
      padding: 0 15px;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .pending { color: var(--color-pending); }
    .preparing { color: var(--color-preparing); }
    .ready { color: var(--color-ready); }
    .delivered { color: var(--color-delivered); }
    
    /* Styles spécifiques aux commandes */
    .commandes-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 15px;
    }
    
    .commande {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .commande-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .table-number {
      font-weight: bold;
      color: var(--color-primary);
      font-size: 1.2em;
    }
    
    .order-time {
      color: #777;
      font-size: 0.9em;
    }
    
    .order-items {
      margin: 10px 0;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .item-quantity {
      font-weight: bold;
      margin-right: 5px;
    }
    
    .order-total {
      font-weight: bold;
      text-align: right;
      margin: 10px 0;
    }
    
    .order-status {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ddd;
    }
    
    .status-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      margin-top: 5px;
    }
    
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--color-danger);
      color: white;
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Styles spécifiques au menu */
    .menu-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .menu-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      position: relative;
    }
    
    .item-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .item-name {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .item-price {
      color: var(--color-primary);
      font-weight: bold;
      margin: 10px 0;
    }
    
    .item-actions {
      display: flex;
      justify-content: space-between;
    }
    
    .edit-btn, .delete-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .edit-btn {
      background-color: #f0ad4e;
      color: white;
    }
    
    .add-item-btn {
      background-color: var(--color-primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .cancel-btn, .save-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .cancel-btn {
      background-color: #ccc;
    }
    
    .save-btn {
      background-color: var(--color-primary);
      color: white;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="showSection('orders')">Commandes</button>
      <button class="tab-btn" onclick="showSection('menu')">Menu</button>
    </div>
    
    <!-- Section des Commandes -->
    <div id="ordersSection">
      <div class="header">
        <h1>Commandes - Dar Hassna</h1>
        <div class="clock" id="liveClock"></div>
      </div>
      
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-value pending" id="pending-count">0</div>
          <div>En attente</div>
        </div>
        <div class="stat-item">
          <div class="stat-value preparing" id="preparing-count">0</div>
          <div>En préparation</div>
        </div>
        <div class="stat-item">
          <div class="stat-value ready" id="ready-count">0</div>
          <div>Prêtes</div>
        </div>
        <div class="stat-item">
          <div class="stat-value delivered" id="delivered-count">0</div>
          <div>Livrées</div>
        </div>
      </div>
      
      <div class="commandes-container" id="liste-commandes"></div>
    </div>
    
    <!-- Section du Menu -->
    <div id="menuSection">
      <div class="header">
        <h1>Gestion du Menu</h1>
        <button class="add-item-btn" id="addItemBtn">+ Ajouter un plat</button>
      </div>
      
      <div class="menu-items" id="menuItemsContainer"></div>
    </div>
  </div>

  <!-- Modal pour le Menu -->
  <div class="modal" id="itemModal">
    <div class="modal-content">
      <h2 id="modalTitle">Ajouter un nouveau plat</h2>
      
      <div class="form-group">
        <label for="itemName">Nom du plat</label>
        <input type="text" id="itemName" required>
      </div>
      
      <div class="form-group">
        <label for="itemPrice">Prix (MAD)</label>
        <input type="number" id="itemPrice" min="0" step="0.01" required>
      </div>
      
      <div class="form-group">
        <label for="itemDescription">Description</label>
        <textarea id="itemDescription" rows="3"></textarea>
      </div>
      
      <div class="form-group">
        <label for="itemImage">Image</label>
        <input type="file" id="itemImage" accept="image/*">
        <img id="imagePreview" class="image-preview" alt="Aperçu de l'image">
      </div>
      
      <div class="form-actions">
        <button class="cancel-btn" id="cancelBtn">Annuler</button>
        <button class="save-btn" id="saveBtn">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDpSF4J0bsd6T0ImMpse0KQQRADaxiYUQw",
      authDomain: "darhassna-484c3.firebaseapp.com",
      databaseURL: "https://darhassna-484c3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "darhassna-484c3",
      storageBucket: "darhassna-484c3.appspot.com",
      messagingSenderId: "141393162149",
      appId: "1:141393162149:web:0717227eac221f5ddfc24c"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    
    // Variables globales
    let currentItemId = null;
    let isEditing = false;
    let selectedImageFile = null;
    let menuItems = {};
    
    // Fonction pour تبديل بين الأقسام
    function showSection(section) {
      document.getElementById('ordersSection').style.display = section === 'orders' ? 'block' : 'none';
      document.getElementById('menuSection').style.display = section === 'menu' ? 'block' : 'none';
      
      // تحديث أزرار التبويب
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    // ==============================================
    // الجزء الخاص بإدارة الطلبات
    // ==============================================
    
    // دالة لتحديث الساعة
    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const dateString = now.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('liveClock').innerHTML = `${dateString}<br>${timeString}`;
    }
    
    // تحديث الساعة كل ثانية
    setInterval(updateClock, 1000);
    updateClock();
    
    // دالة لعرض الطلبات
    function createOrderElement(key, data) {
      const currentStatus = data.etat || data.statut || "En attente";
      const timeString = new Date(data.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      
      const div = document.createElement("div");
      div.className = `commande status-${currentStatus.replace(/\s+/g, '-').toLowerCase()}`;
      div.id = `commande-${key}`;
      
      div.innerHTML = `
        <button class="delete-btn" data-key="${key}">×</button>
        <div class="commande-header">
          <div class="table-number">Table ${data.table}</div>
          <div class="order-time">${timeString}</div>
        </div>
        
        <div class="order-items">
          ${data.commandes.map(item => {
            const menuItem = menuItems[item.plat] || { image: "", defaultPrice: item.prix };
            return `
            <div class="order-item">
              <div>
                ${menuItem.image ? `<img src="${menuItem.image}" style="width:30px;height:30px;object-fit:cover;border-radius:4px;margin-right:5px;" alt="${item.plat}">` : ''}
                <span class="item-quantity">${item.quantite}x</span>
                ${item.plat}
              </div>
              <div>${item.prix * item.quantite} MAD</div>
            </div>
            `;
          }).join('')}
        </div>
        
        <div class="order-total">Total: ${data.total} MAD</div>
        
        <div class="order-status">
          <label>État :</label>
          <select class="status-select" data-key="${key}">
            <option value="En attente" ${currentStatus === "En attente" ? "selected" : ""}>🕐 En attente</option>
            <option value="En préparation" ${currentStatus === "En préparation" ? "selected" : ""}>👨‍🍳 En préparation</option>
            <option value="Prêt" ${currentStatus === "Prêt" ? "selected" : ""}>✅ Prêt</option>
            <option value="Livré" ${currentStatus === "Livré" ? "selected" : ""}>🛵 Livré</option>
          </select>
        </div>
      `;
      
      // إضافة معالج الأحداث لتغيير الحالة
      div.querySelector('.status-select').addEventListener("change", function() {
        const newStatus = this.value;
        db.ref("commandes/" + key).update({ etat: newStatus });
      });
      
      // إضافة معالج الأحداث للحذف
      div.querySelector('.delete-btn').addEventListener("click", function() {
        if (confirm("Voulez-vous vraiment supprimer cette commande ?")) {
          db.ref("commandes/" + key).remove();
        }
      });
      
      return div;
    }
    
    // جلب وتحديث الطلبات
    db.ref("commandes").on("value", (snapshot) => {
      const commandesContainer = document.getElementById("liste-commandes");
      commandesContainer.innerHTML = '';
      
      const orders = snapshot.val();
      if (orders) {
        Object.entries(orders).forEach(([key, data]) => {
          const orderElement = createOrderElement(key, data);
          commandesContainer.appendChild(orderElement);
        });
      }
    });
    
    // ==============================================
    // الجزء الخاص بإدارة القائمة
    // ==============================================
    
    // دالة لفتح نافذة الإضافة/التعديل
    function openModal(editing, item = null) {
      isEditing = editing;
      currentItemId = editing ? item.id : null;
      
      document.getElementById('modalTitle').textContent = editing ? 'Modifier le plat' : 'Ajouter un nouveau plat';
      document.getElementById('itemName').value = editing ? item.name : '';
      document.getElementById('itemPrice').value = editing ? item.price : '';
      document.getElementById('itemDescription').value = editing ? item.description : '';
      
      const imagePreview = document.getElementById('imagePreview');
      if (editing && item.imageUrl) {
        imagePreview.src = item.imageUrl;
        imagePreview.style.display = 'block';
      } else {
        imagePreview.style.display = 'none';
      }
      
      document.getElementById('itemImage').value = '';
      selectedImageFile = null;
      
      document.getElementById('itemModal').style.display = 'flex';
    }
    
    // دالة لإغلاق النافذة
    function closeModal() {
      document.getElementById('itemModal').style.display = 'none';
    }
    
    // دالة لحفظ العنصر
    async function saveMenuItem() {
      const name = document.getElementById('itemName').value.trim();
      const price = parseFloat(document.getElementById('itemPrice').value);
      const description = document.getElementById('itemDescription').value.trim();
      
      if (!name || isNaN(price)) {
        alert('Veuillez remplir tous les champs requis');
        return;
      }
      
      let imageUrl = '';
      
      // رفع الصورة إذا تم اختيارها
      if (selectedImageFile) {
        const storageRef = storage.ref(`menu_images/${selectedImageFile.name}`);
        await storageRef.put(selectedImageFile);
        imageUrl = await storageRef.getDownloadURL();
      } else if (isEditing && document.getElementById('imagePreview').style.display === 'block') {
        // الاحتفاظ بالصورة الحالية إذا لم يتم اختيار صورة جديدة
        imageUrl = document.getElementById('imagePreview').src;
      }
      
      const itemData = {
        name,
        price,
        description,
        imageUrl
      };
      
      if (isEditing) {
        // تحديث العنصر الحالي
        db.ref(`menu/${currentItemId}`).update(itemData);
      } else {
        // إضافة عنصر جديد
        db.ref('menu').push(itemData);
      }
      
      closeModal();
    }
    
    // دالة لحذف العنصر
    function deleteMenuItem(itemId) {
      if (confirm('Voulez-vous vraiment supprimer ce plat ?')) {
        db.ref(`menu/${itemId}`).remove();
      }
    }
    
    // دالة لعرض العناصر
    function renderMenuItems(items) {
      const container = document.getElementById('menuItemsContainer');
      container.innerHTML = '';
      
      if (!items) {
        container.innerHTML = '<p>Aucun plat disponible pour le moment</p>';
        return;
      }
      
      Object.entries(items).forEach(([id, item]) => {
        const menuItemElement = document.createElement('div');
        menuItemElement.className = 'menu-item';
        
        menuItemElement.innerHTML = `
          ${item.imageUrl ? `<img src="${item.imageUrl}" class="item-image" alt="${item.name}">` : ''}
          <div class="item-name">${item.name}</div>
          <div>${item.description || ''}</div>
          <div class="item-price">${item.price} MAD</div>
          <div class="item-actions">
            <button class="edit-btn" data-id="${id}">Modifier</button>
            <button class="delete-btn" data-id="${id}">Supprimer</button>
          </div>
        `;
        
        container.appendChild(menuItemElement);
        
        // إضافة معالج الأحداث للزر تعديل
        menuItemElement.querySelector('.edit-btn').addEventListener('click', () => {
          openModal(true, { id, ...item });
        });
        
        // إضافة معالج الأحداث للزر حذف
        menuItemElement.querySelector('.delete-btn').addEventListener('click', () => {
          deleteMenuItem(id);
        });
      });
    }
    
    // جلب وتحديث القائمة
    db.ref("menu").on("value", (snapshot) => {
      const items = snapshot.val();
      renderMenuItems(items);
      
      // تحديث متغير menuItems للاستخدام في قسم الطلبات
      menuItems = {};
      if (items) {
        Object.entries(items).forEach(([id, item]) => {
          menuItems[item.name] = {
            image: item.imageUrl,
            defaultPrice: item.price
          };
        });
      }
    });
    
    // إعداد معالج الأحداث
    document.getElementById('addItemBtn').addEventListener('click', () => {
      openModal(false);
    });
    
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('saveBtn').addEventListener('click', saveMenuItem);
    
    document.getElementById('itemImage').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          const preview = document.getElementById('imagePreview');
          preview.src = event.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
